/**
 * IDE Control
 *
 * @copyright 2017 Juan Carlos Rodríguez-del-Pino
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @author Juan Carlos Rodríguez-del-Pino <jcrodriguez@dis.ulpgc.es>
 */
define(["jquery","jqueryui","core/url","mod_vpl/vplutil","mod_vpl/vplui","mod_vpl/vplidefile","mod_vpl/vplidebutton","mod_vpl/vplterminal","mod_vpl/vplvnc"],(function(e,t,i,n,o,l,a,r,s){if(void 0!==c)return c;var d,c=function(t,c){var u,f,p,h,g,v,m=this,_=c.minfiles||0,b=c.maxfiles||0,w=c.restrictededitor||c.example,y=c.example,F=c.readOnlyFiles,x=(c.isTeacher,!1),T=o.scrollBarWidth(),L=n.str,M=e("#"+t);if(e("head").append('<meta name="viewport" content="initial-scale=1">').append('<meta name="viewport" width="device-width">').append('<link rel="stylesheet" href="'+i.relativeUrl("/mod/vpl/editor/VPLIDE.css")+'"/>'),"object"!=typeof M)throw new Error("VPL: constructor tag_id not found");var A,z={new:!0,rename:!0,delete:!0,save:!0,run:!0,edit:!0,debug:!0,evaluate:!0,import:!0,resetfiles:!0,sort:!0,multidelete:!0,showparentfiles:!0,acetheme:!0,console:!0,comments:!0};void 0===c.loadajaxurl&&(c.loadajaxurl=c.ajaxurl),A=_<b,c.new=A,c.rename=A,c.delete=A,c.comments=c.comments&&!c.example,c.acetheme=!0,c.sort=b-_>=2,c.multidelete=c.sort,c.import=!w;var C=function(e){return!z[e]||c[e]};function k(e){e.originalEvent.dataTransfer.dropEffect=w?"none":"copy",e.preventDefault()}function N(e){if(w)return e.stopImmediatePropagation(),!1;for(var t=[],i=function(e,o=""){return new Promise((function(l){if(e.isFile)e.file((function(e){var i=o+e.name;Object.defineProperty(e,"name",{get:function(){return i}}),t.push(e),l()}));else if(e.isDirectory){e.createReader().readEntries((function(t){for(var a=[],r=0;r<t.length;r++)a.push(i(t[r],o+e.name+"/"));Promise.all(a).then(l).catch((function(e){n.log("Error reading directory entries: "+e)}))}))}else l()}))},l=e.originalEvent.dataTransfer,a=[],r=0;r<l.items.length;r++){var s=l.items[r].webkitGetAsEntry();if(s)(s.isFile||s.isDirectory)&&a.push(i(s));else{const e=l.items[r].getAsFile();e&&(s={isFile:!0,isDirectory:!1,file:function(t){t(e)}},a.push(i(s)))}}return l.files.length>0&&(Promise.all(a).then((function(){o.readSelectedFiles(t,(function(e){return u.addFile(e,!0,g,h)}),(function(){u.fileListVisibleIfNeeded()}))})).catch((function(e){n.log("Error processing dropped files: "+e)})),e.stopImmediatePropagation(),!1)}function I(e){return!w||(e.stopPropagation(),!1)}c.console=C("run")||C("debug"),void 0===c.fontSize&&(c.fontSize=12),c.fontSize=parseInt(c.fontSize),M.on("drop",N),M.on("dragover",k);var V=e("#vpl_menu"),H=new a(V,C),S=e("#vpl_tr"),O=e("#vpl_filelist"),R=e("#vpl_filelist_header"),E=e("#vpl_filelist_content"),W=e("#vpl_tabs_ul"),P=e("#vpl_tabs"),D=e("#vpl_results"),J=e("#vpl_results_accordion"),j=n.doNothing;O.vplMinWidth=80,D.vplMinWidth=100,this.updateEvaluationNumber=function(e){if(void 0!==e.nevaluations){var t=e.nevaluations;void 0!==e.reductionbyevaluation&&e.reductionbyevaluation>""&&0!=e.reductionbyevaluation&&(0!=e.freeevaluations&&(t=t+"/"+e.freeevaluations),t=t+" -"+e.reductionbyevaluation),H.setExtracontent("evaluate",t)}},this.lastResult=null,this.getTerminal=function(){return be},this.setResultGrade=function(e,t){var i="grade",n="vpl_ide_accordion_t_"+i,o="vpl_ide_accordion_c_"+i;if(0==J.find("."+o).length&&(J.append('<div class="'+n+'"></div>'),J.append('<div class="'+o+'"></div>')),void 0===t)return J.find("h4."+n).length>0;var l=J.find("."+n);return e>""?(l.replaceWith('<h4 class="'+n+'">'+e+"</h4>"),!0):(l.replaceWith('<div class="'+n+'"></div>'),!1)},this.setResultTab=function(t,i,n){var o="vpl_ide_accordion_t_"+t,l="vpl_ide_accordion_c_"+t;if(0==J.find("."+l).length&&(J.append('<div class="'+o+'"></div>'),J.append('<div class="'+l+'"></div>')),void 0===n)return J.find("h4."+o).length>0;var a=J.find("."+o),r=J.find("."+l),s=e("<div>"+i+"</div>");return s.find("h4").replaceWith((function(){return e("<h5>").append(e(this).contents())})),r.html()==s.html()?i>"":i>""?(a.replaceWith('<h4 class="'+o+'">'+L(t)+"</h4>"),r.replaceWith('<div class="ui-widget '+l+'">'+s.html()+"</div>"),!0):(a.replaceWith('<div class="'+o+'"></div>'),r.replaceWith('<div class="'+l+'"></div>'),!1)},this.applyMathJax=function(){if("object"==typeof window.MathJax)try{let e=J.find(".vpl_ide_accordion_c_description")[0];e&&(window.MathJax.Hub&&window.MathJax.Hub.Queue?window.MathJax.Hub.Queue(["Typeset",window.MathJax.Hub,e]):window.MathJax.startup&&window.MathJax.startup.promise&&(window.MathJax.startup.promise=window.MathJax.startup.promise.then((()=>window.MathJax.typesetPromise([e]))).catch((e=>{n.log("MathJax error"+e)}))))}catch(e){n.log("MathJax error"+e)}},this.setResult=function(t,i){m.updateEvaluationNumber(t);var o,l=u.getFiles(),a=[];for(o=0;o<l.length;o++)a[o]=l[o].getFileName(),l[o].clearAnnotations();var r,s,d,c=!1,f=n.sanitizeText(t.grade);if(s=m.setResultGrade(f,t.grade),c=c||s,r=m.setResultTab("variables",t.variables,t.variables),c=c||r,d=n.processResult(t.compilation,a,l,!0,!1),r=m.setResultTab("compilation",d,t.compilation),c=c||r,d=n.processResult(t.evaluation,a,l,!1,!1),r=m.setResultTab("comments",d,t.evaluation),c=c||r,d=n.sanitizeText(t.execution),r=m.setResultTab("execution",d,t.execution),c=c||r,(r=m.setResultTab("description",window.VPLDescription,window.VPLDescription))&&m.applyMathJax(),c=c||r){for(D.show(),D.vplVisible=!0,J.accordion("refresh"),J.accordion("option","active",s?1:0),o=0;o<l.length;o++)for(var h=l[o].getAnnotations(),g=0;g<h.length;g++)if(i||"error"==h[g].type){u.gotoFile(o,h[g].row+1);break}e("#vpl_ide_shrightpanel").show()}else D.hide(),D.vplVisible=!1,e("#vpl_ide_shrightpanel").hide();n.delay("autoResizeTab",p),n.delay("fixAccordion",(function(){J.accordion("option","active",s?1:0)}))},J.accordion({heightStyle:"fill",header:"h4",animate:!1,beforeActivate:function(e,t){return!("newHeader"in t)||!t.newHeader.hasClass("vpl_ide_accordion_t_grade")}}),D.width(2*D.vplMinWidth),J.on("click","a",(function(e){u.gotoFileLink(e.currentTarget)&&e.preventDefault()})),D.vplVisible=!1,D.hide(),O.addClass("ui-tabs ui-widget ui-widget-content ui-corner-all"),R.text(L("filelist")),R.html(o.iconFolder()+R.html()),R.addClass("ui-widget-header ui-button-text-only ui-corner-all"),E.addClass("ui-widget ui-corner-all"),O.width(2*O.vplMinWidth),O.on("click","a",(function(e){e.preventDefault(),u.gotoFileLink(e.currentTarget)})),O.vplVisible=!1,O.hide();var q=!1;function B(){return!1===q&&(q=(P.outerWidth(!0)-P.width())/2),q}function K(e,t){var i,n=t.position.left-t.originalPosition.left;if(0!==n)i=P.width()+O.width()-O.vplMinWidth,P.resizable("option","maxWidth",i),O.width(O.vplOriginalWidth+n);else{i=P.width()+D.width()-D.vplMinWidth,P.resizable("option","maxWidth",i);var o=t.size.width-t.originalSize.width;D.width(D.vplOriginalWidth-o)}u.currentFile("adjustSize")}var U={containment:"parent",resize:K,start:function(){e(window).off("resize",p),P.resizable("option","minWidth",100),D.vplVisible&&(D.vplOriginalWidth=D.width()),O.vplVisible&&(O.vplOriginalWidth=O.width())},stop:function(t,i){K(0,i),P.resizable("option","maxWidth",1e5),P.resizable("option","minWidth",0),p(),e(window).on("resize",p)},handles:""};function G(){u.currentFile("focus")}P.resizable(U),f=function(t){var i=P.width(),n=0;W.width(1e5);var o=W.children("li:visible").last();if(o.length){var l=W.parent().scrollLeft();n=l+o.position().left+o.width()+q,W.width(n);var a=u.currentFile();if(a&&t){var r=e(a.getTabNameId()),s=l+r.position().left;(s-=(i-r.outerWidth())/2)<0&&(s=0),W.parent().finish().animate({scrollLeft:s},"slow")}}n<i&&W.width("")},p=function(){var t,i=P.width(),n=V.width(),o=!1;if(t=0,t+=O.vplVisible?1:0,t+=D.vplVisible?2:0,P.resizable("destroy"),U.handles=["e","w","e","e, w"][t],U.disable=0===t,P.resizable(U),S.width(V.outerWidth()),O.vplVisible){var l=O.outerWidth()+q;i+=l,l>=100?(n-=l,P.css("left",l)):o=!0}else P.css("left",0);if(D.vplVisible){var a=D.outerWidth()+q;i+=a,(n-=a)<100&&(o=!0)}if(o){var r=V.width()/i,s=0;O.vplVisible&&(s=O.width()*r,O.width(s-q),s+=q,P.css("left",s)),P.width(P.width()*r),D.vplVisible&&D.width(V.width()-(s+P.width()+q))}else P.width(n);f(!0),function(){var t=e(window).outerHeight();(t-=V.offset().top+V.height()+(x?B():20))<250&&(t=250),S.height(t);var i=t-3*B();P.height(i),D.vplVisible&&(D.height(i+B()),J.accordion("refresh")),O.vplVisible&&(E.height(i-(R.outerHeight()+B())),O.height(i))}(),u.currentFile("adjustSize")};var $=e.extend({},{close:G},o.dialogbaseOptions);function X(t,i){return o.showMessage(t,e.extend({},$,i))}h=function(e){return o.showErrorMessage(e,{close:G})};var Y=e("#vpl_ide_dialog_new");function Q(t){if("click"!=t.type&&("keypress"!=t.type||13!=t.keyCode))return!0;Y.dialog("close");var i={name:e("#vpl_ide_input_newfilename").val(),contents:"",encoding:0},n=u.addFile(i,!1,g,h);return!!n&&(u.open(n),P.tabs("option","active",u.getTabPos(n.getId())),n.focus(),!0)}var Z={};Z[L("ok")]=Q,Z[L("cancel")]=function(){e(this).dialog("close")},Y.find("input").on("keypress",Q),Y.dialog(e.extend({},$,{title:L("create_new_file"),buttons:Z})),o.setDialogTitleIcon(Y,"new");var ee=e("#vpl_ide_dialog_rename");function te(t){("click"==t.type||"keypress"==t.type&&13==t.keyCode)&&(ee.dialog("close"),u.renameFile(u.currentFile("getFileName"),e("#vpl_ide_input_renamefilename").val(),h),t.preventDefault())}ee.find("input").on("keypress",te),Z[L("ok")]=te,ee.dialog(e.extend({},$,{open:function(){e("#vpl_ide_input_renamefilename").val(u.currentFile("getFileName"))},title:L("rename_file"),buttons:Z})),o.setDialogTitleIcon(ee,"rename");var ie=e("#vpl_ide_dialog_renamedir");function ne(t){("click"==t.type||"keypress"==t.type&&13==t.keyCode)&&(ie.dialog("close"),u.renameDirectory(e("#vpl_ide_input_olddirectoryname").val(),e("#vpl_ide_input_renamedirectory").val(),h),t.preventDefault())}ie.find("input").on("keypress",ne),Z[L("ok")]=ne,ie.dialog(e.extend({},$,{title:L("rename_directory"),buttons:Z})),o.setDialogTitleIcon(ie,"filelist"),j=function(t){if(t.target.hasAttribute("data-dirname")){var i=t.target.getAttribute("data-dirname");e("#vpl_ide_input_olddirectoryname").val(i),e("#vpl_ide_input_renamedirectory").val(i),ie.dialog("open")}};var oe=e("#vpl_ide_dialog_comments"),le="";Z[L("ok")]=function(){le!=e("#vpl_ide_input_comments").val()&&u.setModified(),e(this).dialog("close")},oe.dialog(e.extend({},$,{open:function(){le=e("#vpl_ide_input_comments").val()},title:L("comments"),width:"40em",buttons:Z})),o.setDialogTitleIcon(oe,"comments"),e("#vpl_ide_input_comments").width("30em");var ae=e("#vpl_ide_dialog_about"),re={};re[L("ok")]=function(){e(this).dialog("close")};var se=e("#vpl_ide_dialog_shortcuts");se.dialog(e.extend({},$,{open:function(){var t=H.getShortcuts(u.currentFile("getEditor"));e("#vpl_ide_dialog_shortcuts").html(t)},title:L("shortcuts"),width:400,height:300,buttons:re})),se.dialog("option","height",300),o.setDialogTitleIcon(se,"shortcuts"),re[L("shortcuts")]=function(){e(this).dialog("close"),se.dialog("open")},ae.dialog(e.extend({},$,{open:function(){var t=H.getShortcuts(u.currentFile("getEditor"));ae.next().find("button").filter((function(){return e(this).text()==L("shortcuts")})).button(""!=t?"enable":"disable")},title:L("about"),width:400,height:300,buttons:re})),ae.dialog("option","height",300),o.setDialogTitleIcon(ae,"about");var de=e("#vpl_ide_dialog_sort"),ce={};ce[L("ok")]=function(){var t=u.getFiles(),i=/[^\d]*/,n=[],o=0,l=e("#vpl_sort_list li");if(l.length==t.length){for(l.each((function(){var e=parseInt(this.id.replace(i,""));n.push(t[e])})),o=0;o<l.length;o++)t[o]=n[o];u.setModified(),e(this).dialog("close")}},ce[L("cancel")]=function(){e(this).dialog("close")},de.dialog(e.extend({},$,{title:L("sort"),buttons:ce,open:function(){var t=e("#vpl_sort_list");t.html("");for(var i=u.getFiles(),n=0;n<i.length;n++){var o=e('<li id="vpl_fsort_'+n+'"class="ui-widget-content"></li>');i[n].getId()<_&&o.addClass("ui-state-disabled"),o.text(n+1+"-"+i[n].getFileName()),t.append(o)}t.sortable({items:"li:not(.ui-state-disabled)",placeholder:"ui-state-highlight",start:function(e,t){t.item.addClass("ui-state-highlight")},stop:function(e,t){t.item.removeClass("ui-state-highlight")}}),t.disableSelection()},maxHeight:400})),o.setDialogTitleIcon(de,"sort");var ue=e("#vpl_ide_dialog_multidelete"),fe={};fe[L("selectall")]=function(){e(this).find("input").prop("checked",!0)},fe[L("deselectall")]=function(){e(this).find("input").prop("checked",!1)},fe[L("deleteselected")]=function(){var t=u.getFiles(),i=[];e("#vpl_multidelete_list label").each((function(){var n=e(this);if(n.find("input").prop("checked")){var o=n.data("fileid");i.push(t[o].getFileName())}}));for(var o=0;o<i.length;o++)u.deleteFile(i[o],h);n.delay("updateMenu",g),n.delay("updateFileList",u.updateFileList),e(this).dialog("close")},fe[L("cancel")]=function(){e(this).dialog("close")},ue.dialog(e.extend({},$,{title:L("multidelete"),buttons:fe,open:function(){var t=e("#vpl_multidelete_list");t.html("");for(var i=u.getFiles(),o=_;o<i.length;o++){var l=n.sanitizeText(i[o].getFileName()),a=e('<label><input type="checkbox"> '+l+"</label>");a.data("fileid",o),t.append(a),t.append("<br>")}t.find("label").button()},maxHeight:400,maxWidth:400})),o.setDialogTitleIcon(ue,"multidelete");var pe=e("#vpl_ide_dialog_fontsize"),he=e("#vpl_ide_dialog_fontsize .vpl_fontsize_slider"),ge={};ge[L("ok")]=function(){var t=he.slider("value");u.setFontSize(t),e(this).dialog("close"),n.setUserPreferences({fontSize:t})},ge[L("cancel")]=function(){u.setFontSize(he.data("vpl_fontsize")),e(this).dialog("close")},ge[L("reset")]=function(){he.slider("value",12)},pe.dialog(e.extend({},$,{title:L("fontsize"),buttons:ge,open:function(){he.data("vpl_fontsize",u.getFontSize()),he.slider("value",u.getFontSize())}})),he.slider({min:1,max:48,change:function(){var e=he.slider("value");u.setFontSize(e),pe.find(".vpl_fontsize_slider_value").text(e)}}),o.setDialogTitleIcon(pe,"fontsize");var ve=e("#vpl_ide_dialog_acetheme"),me=e("#vpl_ide_dialog_acetheme select"),_e={};_e[L("ok")]=function(){u.setTheme(me.val()),e(this).dialog("close"),n.setUserPreferences({aceTheme:me.val()})},_e[L("cancel")]=function(){u.setTheme(me.data("acetheme")),e(this).dialog("close")},_e[L("reset")]=function(){me.val(me.data("acetheme")),u.setTheme(me.val())},ve.dialog(e.extend({},$,{title:L("theme"),buttons:_e,modal:!1,open:function(){me.data("acetheme",u.getTheme()),me.val(u.getTheme())}})),me.on("change",(function(){u.setTheme(me.val())})),o.setDialogTitleIcon(ve,"theme");var be=new r("vpl_dialog_terminal","vpl_terminal",L),we=new s("vpl_dialog_vnc",L),ye=be,Fe=e("#vpl_ide_input_file");function xe(){o.requestAction("resetfiles","",{},c.ajaxurl).done((function(e){var t=e.files;for(var i in t)t.hasOwnProperty(i)&&u.addFile(t[i],!0,n.doNothing,h);u.fileListVisibleIfNeeded(),n.delay("updateMenu",g)})).fail(h)}Fe.on("change",(function(){o.readSelectedFiles(this.files,(function(e){return u.addFile(e,!0,g,h)}),(function(){u.fileListVisibleIfNeeded()}))})),H.add({name:"filelist",originalAction:function(){u.fileListVisible(!u.isFileListVisible()),n.delay("updateMenu",g),n.delay("autoResizeTab",p),n.delay("updateFileList",u.updateFileList)},bindKey:{win:"Ctrl-L",mac:"Ctrl-L"}}),H.add({name:"new",originalAction:function(){u.length()<b&&Y.dialog("open")},bindKey:{win:"Alt-N",mac:"Option-N"}}),H.add({name:"rename",originalAction:function(){var e=u.currentFile();e&&e.getId()>=_&&ee.dialog("open")},bindKey:{win:"Ctrl-R",mac:"Ctrl-R"}}),H.add({name:"delete",originalAction:function(){var e=u.currentFile();if(e){var t=e.getFileName();X(L("delete_file_fq",t),{ok:function(){u.deleteFile(t,h)},title:L("delete_file_q"),icon:"trash"})}},bindKey:{win:"Ctrl-D",mac:"Ctrl-D"}}),H.add({name:"close",originalAction:function(){var e=u.currentFile();e&&u.closeFile(e)},bindKey:{win:"Alt-W",mac:"Option-W"}}),H.add({name:"import",originalAction:function(){Fe.val(""),Fe.trigger("click")},bindKey:{win:"Ctrl-I",mac:"Ctrl-I"}}),H.add({name:"sort",originalAction:function(){de.dialog("open")},bindKey:{win:"Ctrl-O",mac:"Ctrl-O"}}),H.add({name:"multidelete",originalAction:function(){ue.dialog("open")}}),H.add({name:"showparentfiles",originalAction:function(){openpopup(null,{url:c.showparentfilesurl,options:"width="+Math.max(screen.availWidth/2,780)+",height="+screen.availHeight+",left="+screen.availWidth/4})}}),H.add({name:"fontsize",originalAction:function(){pe.dialog("open")}}),H.add({name:"theme",originalAction:function(){ve.dialog("open")}}),H.add({name:"print",originalAction:function(){window.print()},bindKey:{win:"Alt-P",mac:"Command-P"}}),H.add({name:"undo",originalAction:function(){u.currentFile("undo")}}),H.add({name:"redo",originalAction:function(){u.currentFile("redo")}}),H.add({name:"select_all",editorName:"selectall",originalAction:function(){u.currentFile("selectAll")}}),H.add({name:"find",originalAction:function(){u.currentFile("find")}}),H.add({name:"find_replace",editorName:"replace",originalAction:function(){u.currentFile("replace")}}),H.add({name:"next",editorName:"findnext",originalAction:function(){u.currentFile("next")}}),H.add({name:"fullscreen",originalAction:function(){x?(M.removeClass("vpl_ide_root_fullscreen"),e("body").removeClass("vpl_body_fullscreen"),H.setText("fullscreen","fullscreen"),e("#vpl_ide_user").hide(),x=!1):(e("body").addClass("vpl_body_fullscreen").scrollTop(0),M.addClass("vpl_ide_root_fullscreen"),H.setText("fullscreen","regularscreen"),c.username&&e("#vpl_ide_user").show(),x=!0),G(),setTimeout(p,10)},bindKey:{win:"Alt-F",mac:"Ctrl-F"}}),H.add({name:"download",originalAction:function(){window.location=c.download}}),H.add({name:"resetfiles",originalAction:function(){X(L("sureresetfiles"),{title:L("resetfiles"),ok:xe,icon:"resetfiles"})}});var Te=!1;function Le(e,t,i){i||(i={}),ye.isConnected()||o.requestAction(e,"",i,c.ajaxurl).done((function(i){o.webSocketMonitor(i,e,t,v)})).fail(h)}function Me(){Le("run","running",{XGEOMETRY:we.getCanvasSize(),currentFileName:u.getCurrentFileName()})}function Ae(){Le("debug","debugging",{XGEOMETRY:we.getCanvasSize(),currentFileName:u.getCurrentFileName()})}function ze(){Le("evaluate","evaluating")}H.add({name:"save",originalAction:function(){var t={files:u.getFilesToSave(),comments:e("#vpl_ide_input_comments").val(),version:Te?-1:u.getVersion()};JSON.stringify(t).length>c.postMaxSize?h(L("maxpostsizeexceeded")):function i(){o.requestAction("save","saving",t,c.ajaxurl).done((function(l){if(l.requestsconfirmation&&!Te){var a,r="vpl_donotshowagain",s='<input type="checkbox" id="'+r+'" class="align-text-bottom mr-1 mt-3"><label for="'+r+'">'+L("donotshowagain")+"</label>";X(l.question+"<br>"+s,{title:L("saving"),icon:"alert",yes:function(){1==a.length&&a.prop("checked")&&(Te=!0),t.version=0,i()}}),a=e("#"+r)}else u.resetModified(),u.setVersion(l.version),H.setTimeLeft(l),n.delay("updateMenu",g),o.monitorRunning()&&(t.processid=n.getProcessId(),o.requestAction("update","updating",t,c.ajaxurl))})).fail(h)}()},bindKey:{win:"Ctrl-S",mac:"Command-S"}}),H.add({name:"run",originalAction:function(){v.setLastAction(Me),Me()},bindKey:{win:"Ctrl-F11",mac:"Command-U"}}),H.add({name:"debug",originalAction:function(){v.setLastAction(Ae),Ae()},bindKey:{win:"Alt-F11",mac:"Option-U"}}),H.add({name:"evaluate",originalAction:function(){v.setLastAction(ze),ze()},bindKey:{win:"Shift-F11",mac:"Command-Option-U"}}),H.add({name:"comments",originalAction:function(){oe.dialog("open")}}),H.add({name:"console",originalAction:function(){ye.isOpen()?ye.close():ye.show()}}),H.add({name:"user"}),H.add({name:"about",originalAction:function(){ae.dialog("open")}}),H.add({name:"timeleft",originalAction:function(){H.toggleTimeLeft()}}),H.add({name:"more",originalAction:function(){var t=e("#vpl_ide_menuextra");t.is(":visible")?(H.setText("more","more",n.str("more")),t.hide()):(H.setText("more","less",n.str("less")),t.show()),n.delay("updateMenu",g),n.delay("autoResizeTab",p)}}),H.add({name:"shrightpanel",icon:"close-rightpanel",originalAction:function(){D.vplVisible?(D.hide(),D.vplVisible=!1,H.setText("shrightpanel","open-rightpanel",n.str("shrightpanel"))):(H.setText("shrightpanel","close-rightpanel",n.str("shrightpanel")),D.show(),D.vplVisible=!0),n.delay("autoResizeTab",p)},bindKey:{win:"Ctrl-M",mac:"Ctrl-M"}});S.append('<span style="position:absolute;right:0;top:60px;z-index:100;margin:3px">'+H.getHTML("shrightpanel")+"</span>");var Ce=e("#vpl_ide_shrightpanel");H.setText("shrightpanel","close-rightpanel",n.str("shrightpanel")),Ce.button(),Ce.css("padding","0"),e("#vpl_ide_shrightpanel.ui-button-text").css("padding","0"),Ce.on("click",(function(){H.launchAction("shrightpanel")})),Ce.hide(),V.addClass("ui-widget-header ui-corner-all");var ke="";ke+=H.getHTML("more"),ke+=H.getHTML("save"),ke+="<span id='vpl_ide_mexecution'>",ke+=H.getHTML("run"),ke+=H.getHTML("debug"),ke+=H.getHTML("evaluate"),ke+=H.getHTML("comments"),ke+=H.getHTML("console"),ke+="</span> ",ke+="<span id='vpl_ide_menuextra'>",ke+="<span id='vpl_ide_file'>",ke+=H.getHTML("filelist"),ke+=H.getHTML("new"),ke+=H.getHTML("rename"),ke+=H.getHTML("delete"),ke+=H.getHTML("import"),ke+=H.getHTML("download"),ke+=H.getHTML("resetfiles"),ke+=H.getHTML("sort"),ke+=H.getHTML("multidelete"),ke+=H.getHTML("showparentfiles"),ke+=H.getHTML("fontsize"),ke+=H.getHTML("theme"),ke+="</span> ",ke+="<span id='vpl_ide_edit'>",ke+=H.getHTML("undo"),ke+=H.getHTML("redo"),ke+=H.getHTML("select_all"),ke+=H.getHTML("find"),ke+=H.getHTML("find_replace"),ke+=H.getHTML("next"),ke+="</span> ",ke+="</span> ",ke+=H.getHTML("fullscreen")+" ",ke+=H.getHTML("about")+" ",ke+=H.getHTML("user")+" ",ke+=H.getHTML("timeleft"),ke+='<div class="clearfix"></div>',V.append(ke),e("#vpl_ide_more").button(),e("#vpl_ide_save").button(),e("#vpl_ide_menuextra").hide(),e("#vpl_ide_file").controlgroup(),e("#vpl_ide_edit").controlgroup(),e("#vpl_ide_mexecution").controlgroup(),e("#vpl_ide_fullscreen").button(),e("#vpl_ide_acetheme").button(),e("#vpl_ide_about").button(),e("#vpl_ide_user").button().css("float","right").hide(),e("#vpl_ide_timeleft").button().css("float","right").hide(),e("#vpl_menu .ui-button").css("padding","6px"),e("#vpl_menu .ui-button-text").css("padding","0");for(var Ne=["filelist","more","fullscreen","about","resetfiles","download","comments","console","import","fontsize","timeleft"],Ie=0;Ie<Ne.length;Ie++)H.enable(Ne[Ie],!0);H.setExtracontent("user",c.username),H.setTimeLeft(c),g=function(){var e,t=u.currentFile(),i=u.length();i?P.show():P.hide(),u.isFileListVisible()?H.setText("filelist","filelistclose",n.str("filelist")):H.setText("filelist","filelist",n.str("filelist"));var l=u.isModified();H.enable("save",l);var a,r=o.monitorRunning();if(r?H.setText("run","running"):H.setText("run","run"),H.enable("run",!r&&(!l||c.example)&&C("run")),H.enable("debug",!r&&(!l||c.example)&&C("debug")),H.enable("evaluate",!r&&(!l||c.example)&&C("evaluate")),H.enable("download",!l),H.enable("new",i<b),H.enable("sort",i-_>1),H.enable("multidelete",i-_>1),H.enable("showparentfiles",!l),H.enable("theme",!0),t&&0!==i)H.enable("rename",t.getId()>=_&&0!==i),H.enable("delete",t.getId()>=_&&0!==i),H.enable("undo",t.hasUndo()),H.enable("redo",t.hasRedo()),H.enable("select_all",t.hasSelectAll()),H.enable("find",t.hasFind()),H.enable("find_replace",t.hasFindReplace()),H.enable("next",t.hasNext()),n.delay("updateFileList",u.updateFileList);else for(a=["rename","delete","undo","redo","select_all","find","find_replace","next"],e=0;e<a.length;e++)H.enable(a[e],!1)},v={open:g,close:g,getConsole:function(){return ye},setResult:m.setResult,ajaxurl:c.ajaxurl,run:function(t,i,o){var l=/^([^:]*):?(.*)/.exec(t),a=n.sanitizeText(l[1]);if("terminal"==a||"webterminal"==a){if(ye&&ye.isOpen()&&ye.close(),ye=be,be.connect(i.executionURL,(function(){o.close(),G()})),"webterminal"==a){var r=(i.secure?"https":"http")+"://"+i.server+":"+i.portToUse;r+="/favicon.ico";var s=e("<img>");s.attr("src",r),s.attr("style","display:none"),e("body").append(s)}}else if("vnc"==a)ye&&ye.isOpen()&&ye.close(),ye=we,we.connect(i.secure,i.server,i.portToUse,i.VNCpassword,i.executionPath,(function(){o.close(),G()}));else if("browser"==a){let e=document.querySelector("div.vpl_vnc.vpl_ide");document.querySelector("div.vpl_vnc.vpl_ide #vpl_dialog_terminal #vpl_terminal div.terminal");var d=(i.secure?"https":"http")+"://"+i.server+":"+i.portToUse+"/";d+=n.sanitizeText(l[2])+"/httpPassthrough",void 0===c||c.closed||(c.close(),e.style.display="block");window.devicePixelRatio;let t=520,o=300;const a=window.top.outerHeight/2+window.top.screenY-o/2,r=window.top.outerWidth/2+window.top.screenX-t/2;var c=window.open(d,"p5js",`toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=${t}, height=${o}, top=${a}, left=${r}`);let s=[],u=!1,f=setInterval((()=>{void 0===c||c.closed||c.postMessage({status:"ok"},"*")}),30);e.style.display="none",ye.write("[2J"),ye.write("[H"),ye.write("[s"),window.onmessage=function(t){if(t.data)if("closing"===t.data)ye.write("[2J"),ye.write("[H"),ye.write("[s"),ye.close();else if("done"===t.data){if(clearInterval(f),u=!0,ye.write("[2J"),ye.write("[H"),s.length>0){e.style.display="block";for(const e of s)ye.write(e),ye.write("\r\n");s=[]}ye.write("[s")}else if(t.data.con&&t.data.args){!0===u&&("none"===e.style.display?(e.style.display="block",ye.write("[2J"),ye.write("[H"),ye.write("[s")):(ye.write("[u"),ye.write("[0J")));let i=JSON.parse(t.data.args);console.log(ye),_msg=i[0],"string"!=typeof _msg&&(_msg=JSON.stringify(i[0])),"log"===t.data.con?!1===u?s.push(_msg):ye.write(_msg+"\r\n"):"warn"===t.data.con?(!1===u?s.push("[33mWarning: "+_msg+"[37m"):ye.write("[33mWarning: "+_msg+"[37m\r\n"),console.warn(i[0])):"error"===t.data.con&&(!1===u?s.push("[91mERROR: "+_msg+"[37m"):ye.write("[91mERROR: "+_msg+"[37m\r\n"),console.warn(i[0])),!0===u&&ye.write("[s")}}}else n.log("Type of run error "+t,!0)},lastAction:!1,getLastAction:function(){var e=this.lastAction;return this.lastAction=!1,e},setLastAction:function(e){this.lastAction=e}},P.on("tabsactivate",(function(){u.currentFile("focus"),n.delay("updateMenu",g),n.delay("autoResizeTab",p)}));var Ve=e(window);Ve.on("resize",p),c.example||Ve.on("beforeunload",(function(){if(u.isModified())return L("changesNotSaved")})),u=new function(){var t=e("#vpl_tabs_ul");e("#vpl_tabs").tabs();var i,a=e("#vpl_tabs").tabs("widget"),r=[],s=[],v=!0,m=this;function x(e){for(var t=e.toLowerCase()+"/",i=0;i<r.length;i++){var n=r[i].getFileName().toLowerCase()+"/";if(0===n.indexOf(t)||0===t.indexOf(n))return!0}return!1}function M(e,t){if(n.isBlockly(e))return!1;if(n.isBlockly(t))for(var i=0;i<r.length;i++)if(n.isBlockly(r[i].getFileName()))return!0;return!1}m.setVersion=function(e){i=e},m.getVersion=function(){return i},this.updateFileList=function(){m.generateFileList()},this.fileNameExists=function(e){for(var t=e.toLowerCase(),i=0;i<r.length;i++)if(r[i].getFileName().toLowerCase()==t)return i;return-1},this.restrictedPaste=I,this.dropHandler=N,this.dragoverHandler=k,this.readOnly=y,this.readOnlyFiles=F,this.restrictedEdit=w,this.adjustTabsTitles=f,this.minNumberOfFiles=_,this.scrollBarWidth=T;var A="";this.setClipboard=function(e){A=e},this.getClipboard=function(){return A},this.getTabPos=function(e){for(var t=0;t<s.length;t++)if(s[t].getId()==e)return t;return s.length},this.getTheme=function(){return c.theme},this.setTheme=function(e){c.theme=e;for(var t=0;t<r.length;t++)r[t].setTheme(e)},this.addTab=function(e){var i='<a href="#vpl_file'+e+'"></a>';t.append('<li id="vpl_tab_name'+e+'">'+i+"</li>"),a.append('<div id="vpl_file'+e+'" class="vpl_ide_file"></div>')},this.removeTab=function(e){t.find("#vpl_tab_name"+e).remove(),a.find("#vpl_file"+e).remove()},this.isReadOnly=function(e){return this.readOnly||-1!=this.readOnlyFiles.indexOf(e)},this.open=function(e){var t;if(!(t="object"==typeof e?e:r[e]).isOpen()){var i=t.getId();m.addTab(i),s.push(t),H.setGetkeys(t.open()),a.tabs("refresh"),f(!1),n.delay("updateFileList",m.updateFileList),n.delay("updateMenu",g)}},this.closeFile=function(e){if(e.isOpen()){var t,i=e.getId();e.close(),o.hideIDEStatus(),m.removeTab(i);var l=m.getTabPos(i);return s.splice(l,1),a.tabs("refresh"),f(!1),m.fileListVisible(!0),n.delay("updateFileList",m.updateFileList),n.delay("adjustTabsTitles",f,!1),s.length==l&&l--,l>=0&&s.length>l?(t=m.getFilePosById(s[l].getId()),void m.gotoFile(t,"c")):void 0}},this.isClosed=function(e){return!r[e].isOpen()},this.fileListVisible=function(e){e!==O.vplVisible&&(e?n.delay("fileListVisible",(function(){O.vplVisible=!0,m.updateFileList(),O.show(),p()})):n.delay("fileListVisible",(function(){O.vplVisible=!1,O.hide(),p()})))},this.isFileListVisible=function(){return O.vplVisible},this.fileListVisibleIfNeeded=function(){if(!this.isFileListVisible())for(var e=0;e<r.length;e++)if(!r[e].isOpen())return void this.fileListVisible(!0)},this.setFontSize=function(e){c.fontSize=e;for(var t=0;t<r.length;t++)r[t].setFontSize(e);be.setFontSize(e)},this.getFontSize=function(){return c.fontSize},this.addFile=function(e,t,i,o){if("string"!=typeof e.name||!n.validPath(e.name))return o(L("incorrect_file_name")+"\n("+e.name+")"),!1;!0!==t&&(t=!1);var a=this.fileNameExists(e.name);if(-1!=a)return t&&!r[a].isReadOnly()?(r[a].setContent(e.contents),m.setModified(),i(),n.delay("updateFileList",m.updateFileList),e):(o(L("filenotadded",e.name)),!1);if(x(e.name)||M("",e.name))return o(L("filenotadded",e.name)),!1;if(r.length>=b)return o(L("maxfilesexceeded")+"\n("+b+")"),!1;var s=n.getUniqueId(),c=new l(s,e.name,e.contents,this,d);return 1==e.encoding?c.extendToBinary():n.isBlockly(e.name)?c.extendToBlockly():c.extendToCodeEditor(),c.setFileName(e.name),r.push(c),m.setModified(),r.length>5&&m.fileListVisible(!0),i(),c},this.renameFile=function(e,t,i){var o=this.fileNameExists(e);try{if(-1==o)throw new Error("Internal error: File name not found");if(r[o].getId()<this.minNumberOfFiles)throw new Error("Internal error: Renaming requested filename");if(r[o].getFileName()==t)return!0;if(!n.validPath(t)||x(t)||M(e,t))throw L("incorrect_file_name");if(n.isBinary(e)&&n.fileExtension(e)!=n.fileExtension(t))throw L("incorrect_file_name");if(n.isBlockly(e)!=n.isBlockly(t)){if(r[o].getContent()>"")X(L("delete_file_fq",e),{ok:function(){var n={name:t,contents:"",encoding:0};u.deleteFile(e,i),u.addFile(n,!1,g,h)&&u.gotoFileName(t)}});else{var l={name:t,contents:"",encoding:0};u.deleteFile(e,i),u.addFile(l,!1,g,i)&&u.gotoFileName(t)}return!0}r[o].setFileName(t)}catch(t){return i(L("filenotrenamed",e)+"\n"+t),!1}return m.setModified(),f(!1),n.delay("updateFileList",m.updateFileList),!0},this.directoryExists=function(e){for(var t=e.toLowerCase()+"/",i=0;i<r.length;i++)if(r[i].getFileName().toLowerCase().startsWith(t))return!0;return!1},this.renameDirectory=function(e,t,i){if(e==t)return!1;try{if(!this.directoryExists(e))throw new Error("Trying to rename a directory that doesn't exist: "+e);if(!n.validPath(t+"/file.txt"))throw L("incorrect_directory_name");var o,l=e.length+1,a=e.toLowerCase()+"/",s=[];for(o=0;o<r.length;o++){var d=r[o].getFileName();if(d.toLowerCase().startsWith(a)){if(r[o].getId()<this.minNumberOfFiles)throw L("incorrect_file_name");s[o]=t+"/"+d.substr(l)}}if(this.directoryExists(t)){var c=[];for(o=0;o<r.length;o++)c[r[o].getFileName().toLowerCase()]=!0;for(o=0;o<r.length;o++)if(s[o]&&c[s[o].toLowerCase()])throw L("incorrect_file_name")}for(o=0;o<s.length;o++)s[o]&&r[o].setFileName(s[o])}catch(t){return i(L("directory_not_renamed",e)+"\n"+t),!1}return m.setModified(),f(!1),n.delay("updateFileList",m.updateFileList),!0},this.deleteFile=function(e,t){var i=this.fileNameExists(e);return-1==i||r[i].getId()<_?(t(L("filenotdeleted",e)),!1):(this.setModified(),this.closeFile(r[i]),r.splice(i,1),0==s.length&&o.hideIDEStatus(),n.delay("updateFileList",m.updateFileList),!0)},this.currentFile=function(){var e=a.tabs("option","active");if(e in s){var t=s[e];if(0===arguments.length)return t;var i=arguments[0];if("function"==typeof t[i]){var n=t[i],o=Array.prototype.slice(arguments);return o.shift(),n.apply(t,o)}}return!1},this.getCurrentFileName=function(){var e="",t=u.currentFile();return t&&(e=t.name),e},this.currentPos=function(){return a.tabs("option","active")},this.getFileTab=function(e){for(var t=0;t<s.length;t++)if(s[t].getId()==e)return t;return-1},this.getFilePosById=function(e){for(var t=0;t<r.length;t++)if(r[t].getId()==e)return t;return-1},this.gotoFile=function(e,t){var i=r[e];m.open(i),a.tabs("option","active",m.getFileTab(i.getId())),"c"!==t&&i.gotoLine(parseInt(t,10)),i.focus()},this.gotoFileLink=function(t){var i=e(t),n=i.data("file"),o=-1;if((o=n>""?this.fileNameExists(n):m.getFilePosById(i.data("fileid")))>=0){var l=i.data("line");return void 0===l&&(l="c"),m.gotoFile(o,l),!0}return!1},this.gotoFileName=function(e,t){var i=this.fileNameExists(e);return i>=0&&(void 0===t&&(t="c"),m.gotoFile(i,t),!0)},this.getFilesToSave=function(){for(var e=[],t=0;t<r.length;t++){var i={};i.name=r[t].getFileName(),i.contents=r[t].getContent(),i.encoding=r[t].isBinary()?1:0,e.push(i)}return e},this.resetModified=function(){v=!1;for(var e=0;e<r.length;e++)r[e].resetModified();n.delay("updateMenu",g),n.delay("updateFileList",m.updateFileList)},this.setModified=function(){v=!0,n.delay("updateFileList",m.updateFileList),n.delay("updateMenu",g)},this.isModified=function(){return v},this.length=function(){return r.length},this.clearAnnotations=function(){for(var e=0;e<r.length;e++)r[e].clearAnnotations()},this.getFile=function(e){return r[e]},this.getFiles=function(){return r},this.getDirectoryStructure=function(){var e={isDir:!0,content:{},path:""};function t(t){for(var i=r[t],n=i.getFileName().split("/"),o=e,l="",a=0;a<n.length;a++){var s=n[a];a==n.length-1?o.content[s]={isDir:!1,content:i,pos:t}:(l+=s,o.content[s]||(o.content[s]={isDir:!0,content:{},path:l}),l+="/",o=o.content[s])}}for(var i in r)r.hasOwnProperty(i)&&t(i);return e},this.generateFileList=function(){if(m.isFileListVisible()){var e=[],t="";!function e(t,i,l){var a,r,s,d,c,u,f,p;for(a in t.content){if(t.content.hasOwnProperty(a))if((r=t.content[a]).isDir)d='href="#" data-dirname="'+n.sanitizeText(r.path)+'" ',s=n.sanitizeText(a),c=i,c+=o.iconFolder()+"<a "+d+">"+s+"</a>",l.push(c),e(r,i+'<span class="vpl_ide_dirindent"></span>',l);else u=r.content,s=n.sanitizeText(a),f=n.sanitizeText(u.getFileName()),u.isOpen()&&(s="<b>"+s+"</b>"),p="<a "+(d='href="#" data-fileid="'+u.getId()+'" title="'+f+'"')+">"+s+"</a>",u.isModified()&&(p=o.iconModified()+p),u.isReadOnly()?p+=o.iconReadOnly():u.getId()<_&&(p+=o.iconRequired()),l.push(i+p)}}(m.getDirectoryStructure(),"",e);for(var i=0;i<e.length;i++)t+=e[i]+"<br>";E.html("<div>"+t+"</div>")}},t.on("click","span.vpl_ide_closeicon",(function(){u.closeFile(u.currentFile())})),t.on("dblclick","span.vpl_ide_closeicon",H.getAction("delete")),t.on("dblclick","a",H.getAction("rename")),E.on("dblclick","a[data-fileid]",H.getAction("rename")),E.on("dblclick","a[data-dirname]",j)},p(),function(){var e=V.width();function t(){var t=V.width();e!=t&&(e=t,p())}t(),setInterval(t,1e3)}(),u.resetModified(),o.requestAction("load","loading",c,c.loadajaxurl).done((function(t){for(var i=!0,o=t.files,l=!1,a=0;a<o.length;a++){var r=o[a],s=u.addFile(r,!1,g,h);s?(s.resetModified(),a<_||o.length<=5?u.open(s):l=!0):i=!1}P.tabs("option","active",0),t.compilationexecution&&m.setResult(t.compilationexecution,!1),H.setTimeLeft(t),t.comments>""&&e("#vpl_ide_input_comments").val(t.comments),i?u.resetModified():u.setModified(),0===u.length()&&b>0?H.getAction("new")():c.saved||u.setModified(),u.setFontSize(c.fontSize),u.setVersion(t.version),u.fileListVisible(l),n.afterAll("AfterLoadFiles",(function(){if(g(),p(),f(!0),u.length()>0){var e=u.getFiles()[0];e.open(),e.focus()}}))})).fail(h)};return window.VPLIDE=c,{init:function(e,t){d=new c(e,t)}}}));